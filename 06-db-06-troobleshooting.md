06-db-06-troobleshooting.md

# Домашнее задание к занятию "6.6. Troubleshooting"

## Задача 1

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести данную операцию:
- напишите список операций, которые вы будете производить для остановки запроса пользователя
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB

### Ответ:

Варианты решения с зависшими запросами (https://www.mongodb.com/docs/manual/tutorial/terminate-running-operations/):

1. Установка ограничения в длительности выполнения операции через maxTimeMS() 
```
db.location.find( { "town": { "$regex": "(Pine Lumber)",
                              "$options": 'i' } } ).maxTimeMS(30)

db.runCommand( { distinct: "collection",
                 key: "city",
                 maxTimeMS: 45 } )
```
2. Использование killOp. Не распространяется на операции записи.
```
db.killOp(<opId>)
```
2. Варианты решения проблем с долгими запросами:
- Изменение характеристик железа, создание индексов, горизонтальное маштабирование.
- Для операций записи : отключение подтверждения записи большинством реплик, отключение подтверждения записи в журнал.
- Для чтения : чтение из sec-реплик (могут быть не совсем актуальные данные)
- Удаление : желательно через коллекции, использование тротлинга, при необходимости удалить большую часть документов в коллекции будет лучше перенести необходимые документы в новую коллекцию и удалить старую.


## Задача 2

Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:
- сначала рост отношения записанных значений к истекшим
- Redis блокирует операции записи

Как вы думаете, в чем может быть проблема?

### Ответ:

- Описание механизма работы - https://redis.io/commands/expire/#how-redis-expires-keys
- Причина блокировки ( блок "C" из статьи) - https://developpaper.com/problems-in-the-use-of-redis-and-how-to-avoid-them-1/

Будет удалять истекшие записи с блокировкой записи до достижения максимального отношения в 25%

### Ответ-доработка:

Вариант решения:
Дополнительно развернуть экземпляр(ы) redis и приложением отправлять данные в разные экземпляры.
 
## Задача 3

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы,
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?

Какие пути решения данной проблемы вы можете предложить?

### Ответ:

Необходимо посмотреть дополнительную информацию в логах. Для получения детальной информации можно запустить процесс с  --log-warnings=2
Понаблюдать использование памяти.

Возможные причины и их решение:

1. Слишком массивный запрос из-за этого сервер обрывает соединение - изменение параметра max_allowed_packet в большую сторону.
2. Проблема с ошибками в оперативной памяти - необходимо запустить тест памяти memtest.
3. Проблема с файлами данных/файлами индексов на уровне устройства/файловой системы. 
4. При нехватке оперативной памяти OOM Killer может убивать в том числе и процесс mysqld - увеличение объема оперативной памяти.

### Ответ-доработка:

Вариант решения:

1. Изменение параметра max_allowed_packet в большую сторону.
2. Необходимо запустить тест памяти memtest для выявления проблем памяти на уровне железа.
3. Проблема с файлами данных/файлами индексов на уровне устройства/файловой системы. Запустить проверку целостности файловой системы. Если проблемы с индексом, то пересоздать, если с файлом данных, то восстановиться из послденей доступной версии
4. Увеличение объема оперативной памяти. Если процесс завершает OOM Killer, то настроить параметры: vm.overcommit_memory=2 + oom_score_adj



## Задача 4


Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объемом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?

Как бы вы решили данную проблему?

### Ответ:

Out-Of-Memory Killer - процесс который завершает приложение при нехватке оперативной памяти. https://habr.com/ru/company/southbridge/blog/464245/

Причин может быть много.
- Неправильно настроенная/расчитанная конфигурация PostgreSQL
- Утечка памяти в других приложениях
- Использование x32 ОС на конфигурации железа, где необходимо использовать x64

### Ответ-доработка:

Варианты решения:
- Мониторинг памяти и определения "плохого" приложения для последующей постановки задачи разработчикам для устранения утечки памяти.
- vm.overcommit_memory=2 + oom_score_adj для postmaster с целью завершения процессов, которые менее критичны к аварийному завершению.
- Использование SWAP? (существуют противники его использования, но думаю если совместить с мониторингом то можно добиться баланса, когда и приложение внезапно не схлопнулось и swap не постоянно используется)

---

### Как cдавать задание

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---
